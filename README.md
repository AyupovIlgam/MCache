# MCache

![image](https://user-images.githubusercontent.com/10988134/179416587-3889008a-707a-473c-8a61-3ef67c85c72d.png)

## В Android есть три типа хранилища:

Внутреннее (internal storage) - приватная папка, которая создается во встроенной памяти телефона в момент установки приложения (e.g. data/data/org.telegram.messenger). Eсли устройство не перепрошито (root device), то файлы в этой папке недоступны другим приложениям.

Основное внешнее (primary external storage) - публичная папка во встроенной памяти телефона (data/media/0). В основном, файлы в этой папке доступны другим приложениям, но к App Specific папкам android ограничивает доступ требованием специальных разрешений. Например, к media/0/Android/data/org.telegram.messenger доступ будет ограничен для других приложений. Но при этом ничего не мешает пользователю подключить телефон к ПК и открыть нужную папку напрямую без всяких ограничений.

Второстепенное внешнее (secondary external storage) - публичная папка в монтируемой памяти (SD карта). Её может вовсе не быть.



## App Specific External Storage

До android 9 (API level 28) приложения имели доступ к App Specific папкам других приложений, что не безопасно. В android 10 - это исправили, доступ теперь возможен только к своей папке. Чтобы облегчить переход в android 10 в manifest файле можно дать послабления, но в android 11 уже нельзя.

У некоторых приложений всё-таки может быть доступ к "App Specific" папкам других приложений. Для этого приложение должно иметь разрешение [MANAGE_DOCUMENTS](https://developer.android.com/reference/android/Manifest.permission#MANAGE_DOCUMENTS). Но это разрешение (signature-level permission) во первых может иметь только одно приложение на телефоне, во вторых оно не выдается обычным приложениям (а только системным/предустановленным от вендора). Примером такого приложения может быть популярный [DocumentsUI](https://source.android.com/devices/architecture/modular-system/documentsui) - часть AOSP.

<img src="https://user-images.githubusercontent.com/10988134/179417294-58eb96af-681e-4763-8e80-25118483abdf.png" width="200"> <img src="https://user-images.githubusercontent.com/10988134/179417297-8cd1c109-ea92-49bd-b882-70adca7c3926.png" width="200">

На первом фото видно что обычный системный проводник не видит содержимое папки media/0/Android/data. В то же время DocumentsUI (второе фото) без проблем открывает все файлы в этой папке потому что у него есть разрешение [MANAGE_DOCUMENTS](https://developer.android.com/reference/android/Manifest.permission#MANAGE_DOCUMENTS).



## Telegram

<img src="https://user-images.githubusercontent.com/10988134/179417461-f03bdac0-e15b-4888-9ff0-e023574191ad.png" width="300">

Из-за обновлений в ОС Android 10 и 11, telegram с ноября 2021 (telegram version 8.2.1) года пришлось изменить место хранения cache файлов. Теперь они хранятся в data/media/0/Android/data/org.telegram.messenger/cache (внешнее App Specific хранилище). Это хранилище недоступно другим приложениям (за исключением системных, вроде DocumentsUI). Подробнее [тут](https://bugs.telegram.org/c/10927/132). 

В комментариях также предлагается сохранять файлы телеграм в общее внешнее хранилище (a.k.a. save to gallery). Позже это перерастет в фукцию в настройках телеграмма (см скриншот). Файлы (после активации save to gallery) сохраняются в data/media/0/Android/media/org.telegram.messenger, где к ним открыт доступ для других приложений.



## Корректная работа приложения...
...возможна если файлы "кэша" Telegram будут сохраняться во внешнем общедоступном для сторонних приложений хранилище. Для этого нужно убедиться что в настройках Telegram активирована опция "Save to Galery". Если опция не была активирована, то после активации ранее закэшированные файлы не перенесутся автоматически. Поэтому желательно ещё дополнительно посмотреть пару публикаций с видео или фото чтобы эти медиа-файлы успели закэшироваться. Также необходимо дать разрешение на чтение внешнего хранилища. Есть поддержка WhatsApp и Viber.
